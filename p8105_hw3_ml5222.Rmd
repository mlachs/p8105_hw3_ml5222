---
title: "p8105_hw3_ml5222"
author: "Miriam Lachs"
date: "2024-10-09"
output: github_document
---

Load packages
```{r,echo=FALSE}
library(tidyverse)
library(patchwork)

```


## Problem 1 

Load data 
```{r}
library(p8105.datasets)

data("ny_noaa")

```

clean the data
```{r}
ny_noaa=
  ny_noaa %>% 
  mutate(
    day=day(date),
    month=month.abb[month(date)],
    year=year(date),
    prcp=prcp/10,
    tmax=as.numeric(tmax)/10,
    tmin=as.numeric(tmin)/10)
```

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n)) %>% 
  head(5) %>% 
  knitr::kable()

  
```


This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Variables in the data set are  id, date converted to year month day, snowfall, snow depth, min temparature and max temperature.The most common observed value is 0, This is likely because most days it doesn't snow.

```{r}
ny_noaa %>% 
  group_by(month,year, id) %>% 
  summarise(avg_max=mean(tmax, na.rm = TRUE)) %>% 
  filter((month=='Jan'|month=="Jul")&avg_max!='NaN') %>% 
  ggplot(aes(x=year,y=avg_max,group = id))+geom_point()+facet_grid(~month)+ 
  labs(title = "Mean temperature by years for Jan and July")


```

It seems like the max temp is lower in Jan then in Jul. There are definitely a few outliers in the Jan data. 

```{r}

minvmax=ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

snowbox=   ny_noaa %>% 
  filter( snow > 0,snow < 100) %>%
  ggplot(aes(x = snow, y = factor(year))) + 
  geom_boxplot()


minvmax + snowbox
```

## Problem 2 


Import, clean and join the data 
```{r}
NHANES_dem=
  read_csv('nhanes_covar.csv',skip=4) %>% 
  janitor::clean_names()
NHANES_acc=read_csv('nhanes_accel.csv') %>% 
  janitor::clean_names()

NHANES_full=
  NHANES_dem %>% 
  left_join(NHANES_acc,'seqn') %>% 
  filter(age>21) %>% 
  drop_na(,c(sex,age,bmi,education)) %>% 
  mutate(
    sex=as.factor(ifelse(sex==1,'male','female')),
    education=factor(case_match(education, 1~'Less than high school',2~'High school equivalent',3~'More than high school'),levels=c('Less than high school','High school equivalent','More than high school'))
         )

```

Produce a reader-friendly tables for count information 
```{r}
NHANES_full %>% 
  select(sex,education,age) %>% 
  group_by(sex,education) %>% 
  count() %>% 
  pivot_wider(names_from = sex,values_from = n) %>% 
  knitr::kable()
```
It looks like participation increased for males as education increased. This pattern is not found in female participents. However for both male and female the majority of the participants have more than high school level education. 


Plot age distributions for men and women in each education category
```{r}

NHANES_full %>% 
  ggplot(aes(x=age,fill = sex))+geom_histogram()+facet_grid(sex~education)
```

Based on these distributions, there doesn't seem to be much difference in the distributions between gender. For participants who have more then high school level education, participation is higher for younger participants. While 
there seems to be more uniform distribution across the other education levels with slightly more older participants. 

Looking at total activity 
```{r}
NHANES_full %>% 
  mutate(total_activity=select(., min1:min1440) %>% rowSums(na.rm = TRUE)) %>% 
  select(seqn,sex,age,education,total_activity) %>% 
  ggplot(aes(x=age,y=total_activity,colour = sex))+geom_point()+facet_grid(~education)+geom_smooth(se=FALSE)
```

Based on these plots we can see that activity tends to decrease as age increases. We also can see that for those with a high school equivalent education or above, women tend to be more active then men. Even with these trends we can see that activity is pretty widely distributed. 

Plot across the day
```{r}
NHANES_full %>% 
  mutate(T00=select(., min1:min60) %>% rowSums(na.rm = TRUE),
         T01=select(., min61:min120) %>% rowSums(na.rm = TRUE),
         T02=select(., min121:min180) %>% rowSums(na.rm = TRUE),
         T03=select(., min181:min240) %>% rowSums(na.rm = TRUE),
         T04=select(., min241:min300) %>% rowSums(na.rm = TRUE),
         T05=select(., min301:min360) %>% rowSums(na.rm = TRUE),
         T06=select(., min361:min420) %>% rowSums(na.rm = TRUE),
         T07=select(., min421:min480) %>% rowSums(na.rm = TRUE),
         T08=select(., min481:min540) %>% rowSums(na.rm = TRUE),
         T09=select(., min541:min600) %>% rowSums(na.rm = TRUE),
         T10=select(., min601:min660) %>% rowSums(na.rm = TRUE),
         T11=select(., min661:min720) %>% rowSums(na.rm = TRUE),
         T12=select(., min721:min780) %>% rowSums(na.rm = TRUE),
         T13=select(., min781:min840) %>% rowSums(na.rm = TRUE),
         T14=select(., min841:min900) %>% rowSums(na.rm = TRUE),
         T15=select(., min901:min960) %>% rowSums(na.rm = TRUE),
         T16=select(., min961:min1020) %>% rowSums(na.rm = TRUE),
         T17=select(., min1021:min1080) %>% rowSums(na.rm = TRUE),
         T18=select(., min1081:min1140) %>% rowSums(na.rm = TRUE),
         T19=select(., min1141:min1200) %>% rowSums(na.rm = TRUE),
         T20=select(., min1201:min1260) %>% rowSums(na.rm = TRUE),
         T21=select(., min1261:min1320) %>% rowSums(na.rm = TRUE),
         T22=select(., min1321:min1380) %>% rowSums(na.rm = TRUE),
         T23=select(., min1381:min1440) %>% rowSums(na.rm = TRUE)
         ) %>% 
  select(seqn,sex,age,bmi,education,T00:T23) %>% 
  pivot_longer(cols = T00:T23,values_to = 'activity',names_to = 'hour') %>% 
  mutate(hour=as.numeric(substr(hour,2,3))) %>% 
  select(sex,age,bmi,education,hour,activity) %>% 
  ggplot(aes(x=hour,y=activity, colour = sex))+geom_point(alpha=.5)+geom_smooth()+facet_grid(~education)+labs(
    title = " Hourly Activity",
    x = "Hour)",
    y = "Activity",
    color = "Sex"  )+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Based on this graph we can make conclusions about when people are most and least active. It seems that people are least active in the middle of the night/ early hours of the morning. Activity rises until about mid day where it starts to decline again. We can also see some outliers of people who were particularly active late in the evening. 
We can also see that male and females are faily simmilar but females with more then a highschool level educaton are slightly more active during the day.
## Problem 3
Load and clean the data 
```{r}
bike_jan_2020= read_csv('citibike/Jan 2020 Citi.csv') %>% 
  mutate(month='Jan',year=2020)
bike_jan_2024= read_csv('citibike/Jan 2024 Citi.csv') %>% 
  mutate(month='Jan',year=2024)
bike_july_2020=read_csv('citibike/July 2020 Citi.csv') %>% 
  mutate(month='July',year=2020)
bike_july_2024= read_csv('citibike/July 2024 Citi.csv') %>% 
  mutate(month='July',year=2024)

citibike_full=
  bind_rows(bike_jan_2020,bike_july_2020,bike_jan_2024,bike_july_2024) %>% 
  mutate(rideable_type=as.factor(rideable_type),
         member_casual=as.factor(member_casual),
        weekdays=factor(weekdays,levels=c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")))
```

Describe the data set

This data contains citibike ride information for two months in different seasons, Jan and July in two different years, 2020 and 2024. There is a total of `r count(citibike_full)` rides recorded in this data with a mean ride duration of rides under 4 hours of `r mean(pull(citibike_full,duration))`. There are `r citibike_full %>% distinct(start_station_name) %>% count()` distinct starting stations. The data set has `r ncol(citibike_full)` variables including, ride id, bike type, weekday, duration, start and end station, member type, and since the data was combined the month and year of the data.


```{r}
citibike_full %>% 
  group_by(month,year,member_casual) %>% 
  summarise(count=n()) %>% 
  pivot_wider(names_from = member_casual,values_from = count) %>% 
  knitr::kable()
```
Looking at the counts of rides between members and casual riders, it seems there are much more member riders then casual riders. However, the difference is lower in magnitude during the month of July, likely due to the nicer weather and therefore more casual rides. It also seems like the program overall has gained popularity over the four year period. 

Top 5 stations for July 2024
```{r}
citibike_full %>% 
  filter(month=='July',year==2024) %>% 
  group_by(start_station_name) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  head(5) %>% 
  knitr::kable()
```

```{r}
citibike_full %>% 
    group_by(weekdays,month,year) %>% 
summarise(median_duration=median(duration)) %>% 
ggplot(aes(x=weekdays,y=median_duration, colour = as.factor(year)))+geom_point()+facet_grid(~month)+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+labs(
    title = "Median Ride Duration by time",
    x = "Day",
    y = "Duration",
    color = "Year"  )
```

By looking at this visualization we can see that during July of 2020 people tended to take the longest bike rides. This was likely due to the ongoing pandemic. However median duration is down in both months in 2024 when compared to the same month in 2020. This could indicate an overall trend of shorter rides over the years. The lower ride duration in Jan compared to July is likely due to the seasons colder weather. There seems to be a slight increase in ride duration on the weekends (Saturday and Sunday) other then Sundays in Jan 2024. 

```{r}
citibike_full %>% 
  filter(year==2024) %>% 
  ggplot(aes(x=month,y=duration,fill = rideable_type))+geom_boxplot()+facet_grid(~member_casual)+labs(
    title = "Median Ride Duration by group",
    x = "month)",
    y = "Duration",
    color = "Bike Type"  )
  
```
The difference between Jan and July duration are less pronounced in this visualization but still present. There seems to also be a slightly larger IQR for the casual riders, although both groups have a large number of longer ride outliers. There is a slight decrease in ride duration of electric bikes within the casual riders, but remains fairly consistent within the member group. 
